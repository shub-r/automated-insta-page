name: Instagram Auto Poster

on:
  schedule:
    # Runs daily at 9:00 AM UTC (configurable)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Manual trigger
    inputs:
      force_day:
        description: 'Force specific day (e.g., "day1")'
        required: false
        default: ''
      force_part:
        description: 'Force specific part number'
        required: false
        default: ''
      reset_errors:
        description: 'Reset consecutive errors count'
        required: false
        default: 'false'

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Reset error count if requested
      if: ${{ github.event.inputs.reset_errors == 'true' }}
      run: |
        echo "Resetting error count..."
        if [ -f state/posting_state.json ]; then
          python3 -c "
          import json
          with open('state/posting_state.json', 'r') as f:
              state = json.load(f)
          state['consecutive_errors'] = 0
          state['error_history'] = []
          with open('state/posting_state.json', 'w') as f:
              json.dump(state, f, indent=2)
          print('Reset consecutive_errors to 0')
          "
        fi
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt
        
    - name: Create configuration file
      run: |
        mkdir -p src
        cat > src/config.py << 'EOF'
        # Auto-generated from GitHub Secrets
        import os
        
        # Facebook/Instagram Credentials
        FACEBOOK_ACCESS_TOKEN = "${{ secrets.FACEBOOK_ACCESS_TOKEN }}"
        FACEBOOK_USER_ID = "${{ secrets.FACEBOOK_USER_ID }}"
        INSTAGRAM_APP_ID = "${{ secrets.INSTAGRAM_APP_ID }}"
        INSTAGRAM_APP_SECRET = "${{ secrets.INSTAGRAM_APP_SECRET }}"
        
        # Google Drive Credentials
        GDRIVE_FOLDER_ID = "${{ secrets.GDRIVE_FOLDER_ID }}"
        GDRIVE_CREDENTIALS = """${{ secrets.GDRIVE_CREDENTIALS }}"""
        
        # Posting Configuration
        POSTING_TIME = "09:00"  # UTC time
        TIMEZONE = "UTC"
        
        # Caption Template
        CAPTION_TEMPLATE = """Day {day_number} - Part {part_number}/{total_parts}

üìÖ Posted automatically on {date}
‚ö° Powered by GitHub Actions & Facebook Graph API

#Day{day_number} #Part{part_number} #InstagramReels #AutoPost #Tech #AI #GitHubActions #Coding #Automation #Reels"""
        
        # Error Handling
        MAX_CONSECUTIVE_ERRORS = 5
        EOF
        
    - name: Create Google Drive credentials file
      run: |
        mkdir -p src
        # Write the credentials JSON directly
        echo '${{ secrets.GDRIVE_CREDENTIALS }}' > src/google_credentials_temp.txt
        # Clean up and format the JSON
        python3 -c "
        import json
        # Read the raw content
        with open('src/google_credentials_temp.txt', 'r') as f:
            content = f.read()
        
        # Remove any escaped newlines if present
        content = content.replace('\\n', '\n')
        
        # Parse JSON to validate
        try:
            creds = json.loads(content)
            # Write properly formatted JSON
            with open('src/google_credentials.json', 'w') as f:
                json.dump(creds, f, indent=2)
            print('‚úÖ Google credentials file created successfully')
        except json.JSONDecodeError as e:
            print(f'‚ùå Failed to parse JSON: {e}')
            print('Content preview:', content[:200])
        "
        rm -f src/google_credentials_temp.txt
        
    - name: Debug - List files
      run: |
        echo "=== Current Directory Structure ==="
        find . -type f -name "*.py" -o -name "*.json" -o -name "*.txt" | sort
        echo "=== State File Content ==="
        cat state/posting_state.json || echo "No state file"
        echo "=== Config File Preview ==="
        head -20 src/config.py || echo "No config file"
        
    - name: Test Google Drive connection
      run: |
        cd src
        python3 -c "
        from google.oauth2 import service_account
        from googleapiclient.discovery import build
        import json
        
        try:
            with open('google_credentials.json', 'r') as f:
                creds_dict = json.load(f)
            
            credentials = service_account.Credentials.from_service_account_info(
                creds_dict,
                scopes=['https://www.googleapis.com/auth/drive.readonly']
            )
            
            service = build('drive', 'v3', credentials=credentials)
            print('‚úÖ Google Drive API connection successful')
            
            # Test listing root folder
            results = service.files().list(
                pageSize=1,
                fields='files(id, name)'
            ).execute()
            
            print(f'‚úÖ Found {len(results.get(\"files\", []))} files')
            
        except Exception as e:
            print(f'‚ùå Google Drive connection failed: {e}')
        "
        
    - name: Run Instagram Poster
      run: |
        cd src
        # Build command with optional arguments
        CMD="python main.py"
        if [ -n "${{ github.event.inputs.force_day }}" ]; then
          CMD="$CMD --force-day=\"${{ github.event.inputs.force_day }}\""
        fi
        if [ -n "${{ github.event.inputs.force_part }}" ]; then
          CMD="$CMD --force-part=${{ github.event.inputs.force_part }}"
        fi
        echo "Running: $CMD"
        eval $CMD
        
    - name: Commit and push state changes
      if: success()
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Check if state file changed
        if ! git diff --quiet state/posting_state.json; then
          echo "Changes detected in state file, committing..."
          git add state/posting_state.json
          git commit -m "üìä Update posting state [skip ci]"
          git push
        else
          echo "No changes to state file"
        fi
        
    - name: Cleanup temporary files
      if: always()
      run: |
        rm -f src/google_credentials.json
        rm -f src/config.py
        rm -f src/*.log
        rm -f src/temp_*.mp4
        
    - name: Upload logs and state on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: debug-logs-${{ github.run_id }}
        path: |
          src/*.log
          state/posting_state.json
          src/config.py
        retention-days: 7
