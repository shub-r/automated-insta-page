name: Instagram Auto Poster

on:
  schedule:
    # Runs daily at 9:00 AM UTC (configurable)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Manual trigger
    inputs:
      force_day:
        description: 'Force specific day (e.g., "day1")'
        required: false
        default: ''
      force_part:
        description: 'Force specific part number'
        required: false
        default: ''

jobs:
  post-to-instagram:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        
    - name: Install dependencies
      run: |
        cd src
        pip install -r requirements.txt
        
    - name: Create configuration file
      run: |
        mkdir -p src
        cat > src/config.py << 'EOF'
        # Auto-generated from GitHub Secrets
        import os
        
        # Facebook/Instagram Credentials
        FACEBOOK_ACCESS_TOKEN = "${{ secrets.FACEBOOK_ACCESS_TOKEN }}"
        FACEBOOK_USER_ID = "${{ secrets.FACEBOOK_USER_ID }}"
        INSTAGRAM_APP_ID = "${{ secrets.INSTAGRAM_APP_ID }}"
        INSTAGRAM_APP_SECRET = "${{ secrets.INSTAGRAM_APP_SECRET }}"
        
        # Google Drive Credentials
        GDRIVE_FOLDER_ID = "${{ secrets.GDRIVE_FOLDER_ID }}"
        # Credentials are loaded from file
        
        # Posting Configuration
        POSTING_TIME = "09:00"  # UTC time
        TIMEZONE = "UTC"
        
        # Caption Template
        CAPTION_TEMPLATE = """Day {day_number} - Part {part_number}/{total_parts}

ðŸ“… Posted automatically on {date}
âš¡ Powered by GitHub Actions & Facebook Graph API

#Day{day_number} #Part{part_number} #InstagramReels #AutoPost #Tech #AI #GitHubActions #Coding #Automation #Reels"""
        
        # Error Handling
        MAX_CONSECUTIVE_ERRORS = 5
        EOF
        
    - name: Create Google Drive credentials
      run: |
        mkdir -p src
        # Use a different method to handle multiline JSON
        echo '${{ secrets.GDRIVE_CREDENTIALS }}' > src/gdrive_creds_temp.json
        # Fix line endings and formatting
        python3 -c "
        import json
        import sys
        # Read the JSON from GitHub Secrets
        with open('src/gdrive_creds_temp.json', 'r') as f:
            data = f.read()
        # Parse and re-serialize to ensure valid JSON
        creds = json.loads(data)
        with open('src/google_credentials.json', 'w') as f:
            json.dump(creds, f, indent=2)
        print('Google credentials file created successfully')
        "
        rm -f src/gdrive_creds_temp.json
        
    - name: Run Instagram Poster
      run: |
        cd src
        # Build command with optional arguments
        CMD="python main.py"
        if [ -n "${{ github.event.inputs.force_day }}" ]; then
          CMD="$CMD --force-day=\"${{ github.event.inputs.force_day }}\""
        fi
        if [ -n "${{ github.event.inputs.force_part }}" ]; then
          CMD="$CMD --force-part=\"${{ github.event.inputs.force_part }}\""
        fi
        echo "Running: $CMD"
        eval $CMD
        
    - name: Commit and push state changes
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Check if there are changes to commit
        if git status --porcelain | grep -q "state/posting_state.json"; then
          echo "Changes detected in state file, committing..."
          git add state/posting_state.json
          git commit -m "ðŸ“Š Update posting state [skip ci]"
          git push
        else
          echo "No changes to state file"
        fi
        
    - name: Cleanup temporary files
      run: |
        rm -f src/google_credentials.json
        rm -f src/config.py
        rm -f src/temp_video.mp4
        rm -f src/*.log
        
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: error-logs-${{ github.run_id }}
        path: |
          src/*.log
          state/posting_state.json
        retention-days: 7
